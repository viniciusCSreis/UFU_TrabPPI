<!DOCTYPE html>
<html lang='pt-br'>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <title>Imobiliaria</title>
    <link rel="shortcut icon" href="../src/img/fiveicon.ico">


    <!-- bootstrap -->
    <link href="https://unpkg.com/ionicons@4.4.2/dist/css/ionicons.min.css" rel="stylesheet">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <!-- Pacote de Icones -->
    <script src="https://unpkg.com/ionicons@4.4.4/dist/ionicons.js"></script>

    <script src="../src/js/global.js"></script>
    <script src="../src/js/logout.js"></script>

    <!-- css -->
    <link rel="stylesheet" href="../src/css/restrito.css">

    <meta name="author" content="Cáliton Marcos, Matheus Araujo, Vinicios Clemente">
    <meta name="description" content="Trabalho de PPI- Imobiliaria">
    <meta name="keywords" content="trabalho, programação, internet, imobiliaria">

</head>
<body>

    <header>
        <div id="navBar"></div>
    </header>

    <div class="container fundo">
        <div class="row">
            <div class="col-md-12">
                <h4 class="card-title" >Lista de Funcionarios</h4>
            </div>
        </div>

        <div class="row" style="margin-bottom: 0.5rem;">
            <div class="col-md-12">
                <span class="float-right"><button id="botao-add" class="btn btn-success btn-sm  "  onclick="cadastrarFuncionario.show();"><ion-icon style="vertical-align: middle;"  name="add"></ion-icon></button></span>
            </div>
        </div>

        <div class="table-responsive-sm">
            <table class="table table-striped table-bordered table-hover ">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Nome</th>
                        <th scope="col">Cpf</th>
                        <th scope="col">Cargo</th>
                        <th scope="col">Ações</th>
                    </tr>
                </thead>
                <tbody>

                    <tr>
                        <td colspan="5" style="text-align: center">Carregando ... </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

</div>

    <!-- Div definindo o conteúdo da janela modal -->
    <div class="modal fade" id="funcionario" role="dialog">
        <div class="modal-dialog modal-lg">

            <div class="modal-content">
                <!-- Cabeçalho da janela modal -->
                <div class="modal-header">
                    <h4 class="modal-title">Funcionario</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <!-- Corpo da janela modal -->
                <div class="modal-body">

                    <form id="detalhes_funcionario">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="email">Email</label>
                                <input name="email" type="email" class="form-control form-control-sm" id="email" placeholder="Digite seu Email">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="senha">Senha</label>
                                <input name="senha" type="password" class="form-control form-control-sm" id="senha" placeholder="Digite sua senha">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="nome">Nome:</label>
                                <input name="nome" type="text" class="form-control form-control-sm" id="nome">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="cpf">CPF:</label>
                                <input name="cpf" type="text" class="form-control form-control-sm" id="cpf">
                            </div>
                        </div>

                        <div id="formEndereco1"></div>

                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="telefone">Telefone Residencial</label>
                                <input name="telefone" type="text" class="form-control form-control-sm" placeholder="0000-0000" id="telefone">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="celular">Telefone Celular</label>
                                <input name="celular" type="text" class="form-control form-control-sm" placeholder="00000-0000" id="celular">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="dt_inicio">Data Inicio</label>
                                <input name="dataInicio" type="date" class="form-control form-control-sm" id="dt_inicio">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="cargo">Cargo: </label>
                                <select class="form-control form-control-sm" id="cargo" name="cargo">
                                        <option value="1">Gerente</option>
                                        <option value="11627" selected>Corretor</option>
                                        <option value="fachineiro" >Fachineiro</option>
                                </select>
                            </div>
                        </div>

                    </form>
                </div>
                <!-- Rodapé da janela modal -->
                <div class="modal-footer">
                    <input type="submit" class="btn btn-danger"  id="excluir" value="Excluir">
                    <input type="submit" class="btn btn-primary"  id= "editar" value="Salvar">
                    <button type="button" class="btn btn-default center_block" data-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal_cadastrar_funcionario"></div>

    <script src="../src/js/NavBarAcessoRestrito.js"></script>
    <script src="../src/js/FormEndereco.js"></script>
    <script src="modal/modal_cadastrar_funcionario.js"></script>

    <script>
        NavBarAcessoRestrito.create(document.getElementById('navBar'));

        var cadastrarFuncionario = new Modal_cadastrar_funcionario( document.getElementById('modal_cadastrar_funcionario') );
        cadastrarFuncionario.create();

        var formEndereco = new FormEndereco(document.getElementById('formEndereco1'));
        formEndereco.create();

        var formEndereco2 = new FormEndereco(document.getElementById('formEndereco2'));
        formEndereco2.create();


        let ajax = new XMLHttpRequest();
        var test;
        ajax.open("GET", window.urlApi.funcionario, true);

        window.funcionarios = {};

        ajax.onreadystatechange = () => {
          if(ajax.readyState === 4 && ajax.status === 200)
          {
            var funcionarios = JSON.parse(ajax.responseText);

            let html = "";
            for(let i = 0 ; i<funcionarios.length ; i++){
              window.funcionarios[funcionarios[i].cpf] = funcionarios[i];

              html += "<tr>";
                html += `<td>${i+1}</td>`;
                html += `<td>${funcionarios[i].nome}</td>`;
                html += `<td>${funcionarios[i].cpf}</td>`;
                html += `<td>${funcionarios[i].cargo}</td>`;
                html += `<td><button class="btn btn-info btn-sm" onClick="openModalByCpf('${funcionarios[i].cpf}')">Descrição</button></td>`;
              html += "</tr>";

            }
            let tbody = document.getElementsByTagName("tbody")[0];
            tbody.innerHTML = html;
          }
        }
        ajax.send();

        function openModalByCpf(cpf){
          $('#nome')[0].value = window.funcionarios[cpf].nome;
          $('#cpf')[0].value = window.funcionarios[cpf].cpf;

          $('.cep')[0].value = window.funcionarios[cpf].Endereco.cep;
          $('.cidade')[0].value = window.funcionarios[cpf].Endereco.cidade;
          $('.uf')[0].value = window.funcionarios[cpf].Endereco.estado;
          $('.rua')[0].value = window.funcionarios[cpf].Endereco.rua;
          $('.numero')[0].value = window.funcionarios[cpf].Endereco.numero;
          $('.bairro')[0].value = window.funcionarios[cpf].Endereco.bairro;

          $('#cargo')[0].value = window.funcionarios[cpf].cargo;
          $('#email')[0].value = window.funcionarios[cpf].usuario;
          $('#senha')[0].value = window.funcionarios[cpf].senha;
          $('#telefone')[0].value = window.funcionarios[cpf].telefone;
          $('#celular')[0].value = window.funcionarios[cpf].celular;
          $('#dt_inicio')[0].value = window.funcionarios[cpf].dataInicio;

          $("#excluir").off('click');
          $('#excluir').click( function (){
            $.ajax({
              url:window.urlApi.funcionario,
              type:"DELETE",
              dataType:"json",
              data:"cpf="+window.funcionarios[cpf].cpf,

              success: function(result) {
                console.log(result);

                location.reload();
              },

              error: function(xhr, status, error){
                console.log(xhr);
                console.log(status);
                console.log(error);
              },

            })

          })
          $("#editar").off('click');
          $('#editar').click( function (){
            $.ajax({
              url:window.urlApi.funcionario,
              type:"PUT",
              dataType:"json",
              data:$("form#detalhes_funcionario").serialize()+"&cpf="+window.funcionarios[cpf].cpf,

              success: function(result) {
                console.log(result);
                //não é necessario dar reload só fiz isso para aparecer na tabela o novo funcionario cadastrado
                location.reload();
              },

              error: function(xhr, status, error){
                console.log(xhr);
                console.log(status);
                console.log(error);
              },

            })

          });
          $('#funcionario').modal("show");
        }

        $("form").submit(function(e){

            console.log(e);
            $.ajax({
              url:e.target.action,
              type:e.target.method,
              dataType:"json",
              data:$(e.target).serialize(),

              success: function(result) {
                console.log(result);
                //não é necessario dar reload só fiz isso para aparecer na tabela o novo funcionario cadastrado
                location.reload();
              },

              error: function(xhr, status, error){
                console.log(xhr);
                console.log(status);
                console.log(error);
              },

            })


            e.preventDefault();



        });
    </script>
</body>
</html>
